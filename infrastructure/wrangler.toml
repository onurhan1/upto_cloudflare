# Cloudflare Workers Configuration for Upto Backend
# This configuration includes API Worker and Monitoring Worker

name = "upto-backend"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "upto-db"
database_id = "" # Will be set after creating the database

# KV Namespaces
[[kv_namespaces]]
binding = "STATUS_SNAPSHOTS"
id = "" # Will be set after creating the namespace

[[kv_namespaces]]
binding = "STATUS_PAGE_CACHE"
id = "" # Will be set after creating the namespace

[[kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "" # Will be set after creating the namespace (optional, falls back to D1)

# Durable Objects
[[durable_objects.bindings]]
name = "SERVICE_STATE"
class_name = "ServiceStateObject"
script_name = "upto-backend"

# Queues
[[queues.producers]]
queue = "monitoring-queue"
binding = "MONITORING_QUEUE"

[[queues.consumers]]
queue = "monitoring-queue"
max_batch_size = 10
max_batch_timeout = 5
max_retries = 3

# R2 Buckets
[[r2_buckets]]
binding = "STATIC_ASSETS"
bucket_name = "upto-static-assets"

# Cron Triggers
[triggers]
crons = ["*/1 * * * *"] # Every minute

# Environment variables
[vars]
ENVIRONMENT = "production"
JWT_SECRET = "" # Set via wrangler secret put JWT_SECRET
TELEGRAM_BOT_TOKEN = "" # Set via wrangler secret put TELEGRAM_BOT_TOKEN
MAILCHANNELS_API_KEY = "" # Set via wrangler secret put MAILCHANNELS_API_KEY

# Development environment
[env.development]
vars = { ENVIRONMENT = "development" }

[env.development.d1_databases]
binding = "DB"
database_name = "upto-db-dev"
database_id = "" # Will be set after creating the database

